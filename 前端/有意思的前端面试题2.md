# 有意思的前端面试题II

还是腾讯的暑期实习生面试题，由于是电话面，面试官口述题目，题目大概是这样的：“有一个对象，对象中有一个方法，方法中又有一个局部函数。问局部函数中的this指向谁？”。翻译成代码就是：

```javascript
var obj = {
    fn: function(){
        function fn2(){
            console.log(this);
        }
        fn2();
    }
}
```

又是让人懵逼的一题。到底在考察什么？函数作用域？`this`指向？在解决这个问题之前，我们先来回顾一下`JavaScript`中`this`的表现，具体可参阅

[`MDN`文档](参阅文档)。

## 1. `this`示例

### 1.1 函数上下文中的`this`

`this`的值取决于函数被调用的方式，可通过`call`、`apply`改变函数执行时的`this`。

### 1.2 `bind`方法

调用`fn.bind(someObject)`会创建一个与`fn`具有相同函数体和作用域的函数，但是在这个新函数中，`this`将永久地被绑定到了`bind`的第一个参数，无论这个函数是如何被调用的。

### 1.3 箭头函数

在箭头函数中，`this`与封闭词法环境的`this`保持一致。在全局代码中，它将被设置为全局对象。无论如何，箭头函数的 `this` 被设置为它被创建时的环境。这同样适用于在其他函数内创建的箭头函数：这些箭头函数的`this`被设置为封闭的词法环境的`this`。

### 1.4 作为对象的方法

当函数作为对象里的方法被调用时，`this` 被设置为调用该函数的对象。这样的行为完全不会受函数定义方式或位置的影响。`this` 的绑定只受最接近的成员引用的影响。

### 1.5 原型链中的`this`

对于在对象原型链上某处定义的方法，同样的概念也适用。如果该方法存在于一个对象的原型链上，那么 `this` 指向的是调用这个方法的对象，就像该方法就在这个对象上一样。

### 1.6 getter与setter中的`this`

再次，相同的概念也适用于当函数在一个 `getter` 或者 `setter` 中被调用。用作 `getter` 或 `setter` 的函数都会把 `this` 绑定到设置或获取属性的对象。

### 1.7 作为构造函数

当一个函数用作构造函数时（使用`new`关键字），它的`this`被绑定到正在构造的新对象。

### 1.8 作为一个DOM事件处理函数

当函数被用作事件处理函数时，它的 `this` 指向触发事件的元素。

### 1.9 作为一个内联事件处理函数

当代码被内联`on-event`处理函数调用时，它的`this`指向监听器所在的DOM元素。

### 1.10 类中的`this`

和其他普通函数一样，方法中的 `this` 值取决于它们如何被调用。

## 2. 尝试解决

回头看面试题中的例子，`fn2`中的`this`和上述示例中的1.1还是比较像的，`this`的值取决于函数被调用的方式，但具体是谁呢？很多人就会想了，调用嵌套函数时`this`会指向调用外层函数的上下文，在这里也就是`fn`的上下文，但这么理解是不对的。和变量不同，关键字`this`没有作用域的限制，嵌套的函数不会从调用它的函数中继承`this`。在**《JavaScript权威指南》**中，有明确给出这个问题的答案：“如果嵌套函数作为方法调用，其`this`的值指向调用它的对象。如果嵌套函数作为函数调用，其`this`值不是全局对象（非严格模式下）就是`undefined`（严格模式下）”。

再来看`MDN`文档中关于`this`示例1.1的描述，给了这么一个例子：

```javascript
// 声明一个变量，并将该变量作为全局对象 window 的属性。
var a = 'Global';

function whatsThis() {
  return this.a; // this的值取决于函数被调用的方式
}

whatsThis(); // 'Global'，因为在这个函数中this没有被设定，所以它默认为全局/window对象
```

`whatsThis`作为函数调用，没有设定`this`，所以它默认为`全局/window对象`。`fn2`中的`this`可参考此例。

如果想访问这个外部函数的`this`，需要将`this`的值保存在一个变量里，这个变量和内部函数都在同一个作用域内。通常使用变量`self`来保存`this`，比如：

```javascript
var obj = {
    fn: function(){
        var self = this;
        console.log(this === obj); // true，this就是这个对象obj
        function fn2(){
            console.log(this === obj); // false，this的值是全局对象或undefined
            console.log(self === obj); // true，self指外部函数的this值
        }
        fn2();
    }
}
```

